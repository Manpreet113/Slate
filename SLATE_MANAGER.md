# Slate Configuration Manager

The Rust-based configuration manager for Slate. Replaces fragile symlinks with dynamic template rendering.

## Philosophy

**Tool, Not Jailer.**
- Only acts when explicitly told
- No daemon, no automatic overwrites
- `~/.config` is a build target, not sacred ground

## Installation

1. Build the manager:
```bash
cargo build --release
```

2. **First-time setup** - Run the installer:
```bash
./target/release/slate install
```

This will:
- Check system requirements (LUKS, UEFI)
- Configure `systemd-boot` with Unified Kernel Images (UKI)
- Auto-detect hardware UUIDs
- Install all required packages via `ax`
- Initialize templates in `~/.config/slate/templates`

## Usage

### `slate check`
Verifies system requirements:
- Confirms Arch Linux
- Verifies LUKS encryption on root partition
- Traces `/dev/mapper/root` → physical device → LUKS UUID
- Lists installed packages

**Note:** Requires `sudo` to read partition UUIDs.

```bash
slate check --verbose
```

### `slate reload`
Renders all enabled templates and atomically writes to `~/.config/`:

```bash
# See what would be generated
slate reload --dry-run

# Actually write the configs
slate reload
```

**Pipeline:**
1. **Render** all templates to memory (fails fast on errors)
2. **Write** all to `.tmp` files
3. **Rename** atomically to final paths
4. **Signal** apps to reload (Waybar, Hyprland, Mako)

### `slate set`
Update a value in `slate.toml` and auto-trigger reload:

```bash
# Change accent color
slate set palette.accent "#ff5555"

# Change monitor scale
slate set hardware.monitor_scale 1.5

# Dry run
slate set palette.bg_void "#000000" --dry-run
```

**Valid keys:**
- `palette.bg_void`
- `palette.foreground`
- `palette.accent`
- `hardware.monitor_scale`
- `hardware.font_family`
- `hardware.root_uuid`

## Template Syntax

Templates use Tera with custom color filters:

```css
/* CSS - use css_rgba filter */
background-color: {{ palette.bg_void | css_rgba }};
color: {{ palette.accent | css_rgba }};

/* Access hardware */
font-family: {{ hardware.font_family }};
```

```conf
# Kernel cmdline - use root_uuid
rd.luks.name={{ hardware.root_uuid }}=root root=/dev/mapper/root
```

```conf
# Ghostty - raw hex values
background = {{ palette.bg_void }}
foreground = {{ palette.foreground }}
```

### Available Filters

- `css_rgba` → `rgba(11, 12, 16, 1.0)`
- `rofi` → `#0b0c10ff`
- `hex` → `#0b0c10`

## Adding New Apps

Edit `~/.config/slate/slate.toml`:

```toml
[[apps]]
name = "my-app"
enabled = true
template_path = "my-app/config"      # Relative to ~/.config/slate/templates/
config_path = "my-app/config"        # Relative to ~/.config/
reload_signal = { type = "signal", signal = "my-app" }  # or { type = "none" }
```

Create the template at `~/.config/slate/templates/my-app/config`, then run `slate reload`.

## Files

```
~/.config/slate/
├── slate.toml              # Central state (user edits this)
└── templates/              # Blueprint configs (user edits these)
    ├── waybar/
    │   ├── style.css
    │   └── config
    ├── ghostty/
    │   └── config
    └── systemd/            # Bootloader templates
        ├── slate.conf
        ├── mkinitcpio.conf
        └── linux.preset

~/.config/                  # Live configs (generated by `slate reload`)
├── waybar/
│   ├── style.css
│   └── config
└── ghostty/
    └── config
```

## Troubleshooting

**"Could not determine home directory"**
- The `HOME` environment variable is not set

**"Failed to render template: waybar/style.css"**
- Template syntax error (check your `{{ }}` placeholders)
- Missing filter or variable

**"Slate strictly requires LUKS encrypted root partition"**
- Your root device is not mapped through `/dev/mapper/`
- This is by design - Slate refuses to operate on unencrypted systems

**Waybar didn't reload after `slate reload`**
- Check if Waybar is running: `pgrep waybar`
- Manually reload: `pkill -SIGUSR2 waybar`
