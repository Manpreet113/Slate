# Slate Configuration Manager

The Rust-based configuration manager for Slate. Replaces fragile symlinks with dynamic template rendering.

## Philosophy

**Tool, Not Jailer.**
- Only acts when explicitly told
- No daemon, no automatic overwrites
- `~/.config` is a build target, not sacred ground

## Installation

1. Build the manager:
```bash
cargo build --release
```

2. **First-time setup** - Create the config directory:
```bash
mkdir -p ~/.config/slate/templates
```

3. Copy the example config:
```bash
cp example.slate.toml ~/.config/slate/slate.toml
```

4. Copy templates:
```bash
cp -r templates/* ~/.config/slate/templates/
```

5. Run system check:
```bash
cargo run -- check --verbose
```

6. Update the PARTUUID in `.config/slate/slate.toml` with the value from check output

## Usage

### `slate check`
Verifies system requirements:
- Confirms Arch Linux
- Verifies LUKS encryption on root partition
- Traces `/dev/mapper/root` → physical device → PARTUUID
- Lists installed packages

**Note:** Requires `sudo` to read partition UUIDs.

```bash
cargo run -- check --verbose
```

### `slate reload`
Renders all enabled templates and atomically writes to `~/.config/`:

```bash
# See what would be generated
cargo run -- reload --dry-run

# Actually write the configs
cargo run -- reload
```

**Pipeline:**
1. **Render** all templates to memory (fails fast on errors)
2. **Write** all to `.tmp` files
3. **Rename** atomically to final paths
4. **Signal** apps to reload (Waybar, Hyprland, Mako)

### `slate set`
Update a value in `slate.toml` and auto-trigger reload:

```bash
# Change accent color
cargo run -- set palette.accent "#ff5555"

# Change monitor scale
cargo run -- set hardware.monitor_scale 1.5

# Dry run
cargo run -- set palette.bg_void "#000000" --dry-run
```

**Valid keys:**
- `palette.bg_void`
- `palette.foreground`
- `palette.accent`
- `hardware.monitor_scale`
- `hardware.font_family`
- `hardware.root_partuuid`

##Template Syntax

Templates use Tera with custom color filters:

```css
/* CSS - use css_rgba filter */
background-color: {{ palette.bg_void | css_rgba }};
color: {{ palette.accent | css_rgba }};

/* Access hardware */
font-family: {{ hardware.font_family }};
```

```toml
# Limine bootloader - use plymouth filter for 0xRRGGBB format
term_background: {{ palette.bg_void | plymouth }}

# Use hardware.root_partuuid for boot params
cmdline: cryptdevice=PARTUUID={{ hardware.root_partuuid }}:root
```

```conf
# Ghostty - raw hex values
background = {{ palette.bg_void }}
foreground = {{ palette.foreground }}
```

### Available Filters

- `css_rgba` → `rgba(11, 12, 16, 1.0)`
- `rofi` → `#0b0c10ff`
- `plymouth` → `0x0b0c10`
- `hex` → `#0b0c10`

## Adding New Apps

Edit `~/.config/slate/slate.toml`:

```toml
[[apps]]
name = "my-app"
enabled = true
template_path = "my-app/config"      # Relative to ~/.config/slate/templates/
config_path = "my-app/config"        # Relative to ~/.config/
reload_signal = { type = "signal", signal = "my-app" }  # or { type = "none" }
```

Create the template at `~/.config/slate/templates/my-app/config`, then run `slate reload`.

## Migrating from install.sh

The old symlink-based system and the new template system can coexist:

1. **Keep using** `install.sh` for package installation and initial setup
2. **Use `slate` manager** for config rendering and updates

To fully migrate:
1. Copy existing dotfiles to `~/.config/slate/templates/`
2. Replace hardcoded values with `{{ palette.* }}` and `{{ hardware.* }}`
3. Add app entries to `slate.toml`
4. Run `slate reload` to test
5. If working, remove old symlinks:
   ```bash
   rm ~/.config/waybar ~/.config/hypr ~/.config/ghostty  # etc
   ```

## Files

```
~/.config/slate/
├── slate.toml              # Central state (user edits this)
└── templates/              # Blueprint configs (user edits these)
    ├── waybar/
    │   ├── style.css
    │   └── config
    ├── ghostty/
    │   └── config
    └── limine.conf

~/.config/                  # Live configs (generated by `slate reload`)
├── waybar/
│   ├── style.css
│   └── config
└── ghostty/
    └── config
```

## Troubleshooting

**"Could not determine home directory"**
- The `HOME` environment variable is not set

**"Failed to render template: waybar/style.css"**
- Template syntax error (check your `{{ }}` placeholders)
- Missing filter or variable

**"Slate strictly requires LUKS encrypted root partition"**
- Your root device is not mapped through `/dev/mapper/`
- This is by design - Slate refuses to operate on unencrypted systems

**Waybardidn't reload after `slate reload`**
- Check if Waybar is running: `pgrep waybar`
- Manually reload: `pkill -SIGUSR2 waybar`
